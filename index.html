<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‹±å˜èªãƒ†ã‚¹ãƒˆ</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background-color: #f0f0f0;
            padding-top: 40px;
        }

        h1 { text-align: center; }

        .container {
            text-align: center;
            margin-top: 10px;
        }

        label { font-size: 18px; margin-right: 10px; }

        input {
            font-size: 16px;
            padding: 5px;
            margin: 10px;
        }

        button {
            font-size: 18px;
            padding: 10px 20px;
            margin: 10px;
            cursor: pointer;
        }

        #timer {
            font-size: 24px;
            font-weight: bold;
            color: #d9534f;
        }

        #question, #answer, #result {
            font-size: 18px;
            margin-top: 20px;
        }

        #timerContainer {
            margin-top: 20px;
            font-size: 30px;
            font-weight: bold;
            color: #333;
        }

        table {
            border-collapse: collapse;
            margin-top: 20px;
        }

        th, td {
            border: 1px solid #999;
            padding: 8px 12px;
        }

        th {
            background-color: #ddd;
        }
    </style>
</head>
<body>
    <h1>è‹±å˜èªãƒ†ã‚¹ãƒˆ</h1>

    <div class="container">
        <label for="startRange">é–‹å§‹ç•ªå·:</label>
        <input type="number" id="startRange" value="1" min="1"><br>

        <label for="endRange">çµ‚äº†ç•ªå·:</label>
        <input type="number" id="endRange" value="75" min="1"><br>
<label for="testTime">ãƒ†ã‚¹ãƒˆæ™‚é–“ï¼ˆåˆ†ï¼‰:</label>
<input type="number" id="testTime" value="30" min="0" max="120"><br>

        <button id="startButton">ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
    </div>

    <div id="timerContainer" style="display:none;">
        <div id="timer">30:00</div>
    </div>

    <div id="question"></div>
    <div id="answer"></div>
    <div id="result"></div>

<script>
    let allWords = [];
    let currentQuestionIndex = 0;
    let correctAnswers = 0;
    let testWords = [];
    let timerInterval;
    let timeRemaining = 0;
    let userAnswers = [];

    async function loadWords() {
        try {
            const response = await fetch('words.json');
            const data = await response.json();
            allWords = data;
        } catch (error) {
            alert("å˜èªãƒªã‚¹ãƒˆã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
        }
    }

function selectWordsInRange(start, end, numWords) {
    const filteredWords = allWords.filter(word => word.id >= start && word.id <= end);

    // ğŸŸ¥ ç¯„å›²ã«å˜èªãŒ1ã¤ã‚‚ãªã„å ´åˆ â†’ è­¦å‘Šã—ã¦ä¸­æ–­
    if (filteredWords.length === 0) {
        alert("æŒ‡å®šã—ãŸç¯„å›²ã«å˜èªãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
        return [];
    }

    // ğŸŸ¢ ç¯„å›²ãŒ30å˜èªã´ã£ãŸã‚Š â†’ ãƒ©ãƒ³ãƒ€ãƒ ã«20å˜èªå‡ºé¡Œ
    if (filteredWords.length === 30) {
        return shuffleArray(filteredWords).slice(0, 20);
    }

    // ğŸŸ¢ ç¯„å›²ãŒ30ã‚ˆã‚Šå¤šã„ â†’ ãƒ©ãƒ³ãƒ€ãƒ ã«30å•å‡ºé¡Œ
    if (filteredWords.length > numWords) {
        return shuffleArray(filteredWords).slice(0, numWords);
    }

    // ğŸŸ¢ ç¯„å›²ãŒ30æœªæº€ â†’ å…¨éƒ¨å‡ºé¡Œ
    return shuffleArray(filteredWords);
}


    function shuffleArray(arr) {
        for (let i = arr.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [arr[i], arr[j]] = [arr[j], arr[i]];
        }
        return arr;
    }

    
    function updateTimer() {
        let minutes = Math.floor(timeRemaining / 60);
        let seconds = timeRemaining % 60;
        if (seconds < 10) seconds = '0' + seconds;
        document.getElementById('timer').textContent = `${minutes}:${seconds}`;
        timeRemaining--;

        if (timeRemaining < 0) {
            clearInterval(timerInterval);
            playBeepSound(); // â† ã“ã“ã§ã€Œãƒ”ãƒ”ãƒ”ã€é³´ã‚‹ï¼
            alert('æ™‚é–“ã«ãªã‚Šã¾ã—ãŸï¼ãƒ†ã‚¹ãƒˆã‚’é–‹å§‹ã—ã¾ã™ã€‚');
            startTest();
        }
    }

    // ğŸ”” ã€Œãƒ”ãƒ”ãƒ”ã€ã¨3å›é³´ã‚‰ã™é–¢æ•°ï¼ˆupdateTimerã®å¤–ã«é…ç½®ï¼ï¼‰
   // ğŸ”” ã€Œãƒ”ãƒ”ãƒ”ã€ã‚’3å›ç¹°ã‚Šè¿”ã™ï¼ˆåˆè¨ˆ9éŸ³ï¼‰
function playBeepSound() {
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const singleBeepDuration = 0.1;  // 1å›ã®ã€Œãƒ”ã€ã®é•·ã•
    const innerGap = 0.08;           // ã€Œãƒ”ãƒ”ãƒ”ã€ã®ä¸­ã®é–“éš”
    const groupGap = 0.6;            // ã€Œãƒ”ãƒ”ãƒ”ã€ã‚»ãƒƒãƒˆé–“ã®é–“éš”
    const frequency = 900;           // éŸ³ã®é«˜ã•ï¼ˆHzï¼‰
    const groupCount = 3;            // ã€Œãƒ”ãƒ”ãƒ”ã€ã‚’3å›ç¹°ã‚Šè¿”ã™

    let timeOffset = 0;

    for (let g = 0; g < groupCount; g++) {
        for (let i = 0; i < 3; i++) {  // å„ã‚°ãƒ«ãƒ¼ãƒ—å†…ã®ã€Œãƒ”ãƒ”ãƒ”ã€
            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);

            oscillator.type = 'sine';
            oscillator.frequency.setValueAtTime(frequency, audioCtx.currentTime);

            const startTime = audioCtx.currentTime + timeOffset;
            const stopTime = startTime + singleBeepDuration;

            gainNode.gain.setValueAtTime(0.2, startTime);
            gainNode.gain.exponentialRampToValueAtTime(0.001, stopTime);

            oscillator.start(startTime);
            oscillator.stop(stopTime);

            // æ¬¡ã®ã€Œãƒ”ã€ã¾ã§ã®é–“éš”
            timeOffset += singleBeepDuration + innerGap;
        }

        // æ¬¡ã®ã€Œãƒ”ãƒ”ãƒ”ã€ã¾ã§ã®é–“éš”
        timeOffset += groupGap;
    }
}


    function startTest() {
        currentQuestionIndex = 0;
        correctAnswers = 0;
        userAnswers = [];
        showQuestion(testWords[currentQuestionIndex]);
    }

    function showQuestion(word) {
    // æ—¥æœ¬èªã®ã€Œã€ã€ã€Œ;ã€ã€Œï¼›ã€ã‚’ã€Œãƒ»ã€ã«å¤‰æ›ã—ã¦è¡¨ç¤º
    const jpText = word.jp.replace(/[ã€;ï¼›]/g, 'ãƒ»');
    document.getElementById('question').textContent = `æ—¥æœ¬èª: ${jpText}`;
    document.getElementById('answer').innerHTML = `
        è‹±èª: <input type="text" id="userAnswer" placeholder="è‹±èªã®ç­”ãˆã‚’å…¥åŠ›">
        <br>ã‚«ã‚¿ã‚«ãƒŠ: <input type="text" id="userKatakanaAnswer" placeholder="ã‚«ã‚¿ã‚«ãƒŠã®ç­”ãˆã‚’å…¥åŠ›">
        <button onclick="checkAnswer()">ç­”ãˆã‚‹</button>`;
}


  function checkAnswer() {
    // ç¾åœ¨ã®å•é¡ŒãŒå­˜åœ¨ã™ã‚‹ã‹å®‰å…¨ç¢ºèª
    if (!testWords || !testWords[currentQuestionIndex]) return;

    const word = testWords[currentQuestionIndex];
    const userAnswer = document.getElementById('userAnswer').value.trim();
    const userKatakanaAnswer = document.getElementById('userKatakanaAnswer').value.trim();

    userAnswers.push({
        jp: word.jp,
        correct: word.en,
        user: userAnswer,
        katakana: userKatakanaAnswer
    });

    if (userAnswer.toLowerCase() === word.en.toLowerCase()) {
        correctAnswers++;
    }

    currentQuestionIndex++;

    // å‡ºé¡Œæ•°ï¼ˆtestWords.lengthï¼‰ã«åˆã‚ã›ã¦çµ‚äº†åˆ¤å®š
    if (currentQuestionIndex < testWords.length) {
        showQuestion(testWords[currentQuestionIndex]);
    } else {
        showResults();
    }
}

    

 function showResults() {
    document.getElementById('question').style.display = 'none';
    document.getElementById('answer').style.display = 'none';

    // å‡ºé¡Œæ•°ã«åˆã‚ã›ã¦æ­£è§£æ•°ã‚’è¡¨ç¤º
    let resultHTML = `<h2>ãƒ†ã‚¹ãƒˆçµ‚äº†ï¼</h2><p>æ­£è§£æ•°: ${correctAnswers} / ${testWords.length}</p>`;
    resultHTML += `<table>
        <tr><th>æ—¥æœ¬èª</th><th>æ­£è§£ï¼ˆè‹±èªï¼‰</th><th>ã‚ãªãŸã®ç­”ãˆ</th><th>ã‚«ã‚¿ã‚«ãƒŠ</th></tr>`;

    userAnswers.forEach(a => {
        const isCorrect = a.user.toLowerCase() === a.correct.toLowerCase();
        // æ—¥æœ¬èªã®ã€Œã€ã€ã€Œ;ã€ã€Œï¼›ã€ã‚’ã€Œãƒ»ã€ã«å¤‰æ›
        const jpText = a.jp.replace(/[ã€;ï¼›]/g, 'ãƒ»');
        resultHTML += `
            <tr style="background-color:${isCorrect ? '#c8e6c9' : '#ffcdd2'}">
                <td>${jpText}</td>
                <td>${a.correct}</td>
                <td>${a.user}</td>
                <td>${a.katakana}</td>
            </tr>`;
    });

    resultHTML += `</table>`;
    document.getElementById('result').innerHTML = resultHTML;
}



    document.getElementById('startButton').addEventListener('click', async function() {
    await loadWords();

    const startRange = parseInt(document.getElementById('startRange').value, 10);
    const endRange = parseInt(document.getElementById('endRange').value, 10);
    const numWords = 30;

    // ğŸŸ¢ è¿½åŠ ï¼šãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå…¥åŠ›ã—ãŸãƒ†ã‚¹ãƒˆæ™‚é–“ï¼ˆåˆ†ï¼‰ã‚’å–å¾—
    const testTimeMinutes = parseInt(document.getElementById('testTime').value, 10);
    if (isNaN(testTimeMinutes) || testTimeMinutes < 0) {
        alert('ãƒ†ã‚¹ãƒˆæ™‚é–“ã‚’æ­£ã—ãå…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
        return;
    }

    testWords = selectWordsInRange(startRange, endRange, numWords);
    if (testWords.length > 0) {
        document.getElementById('startButton').style.display = 'none';
        document.getElementById('timerContainer').style.display = 'block';

        // ğŸŸ¢ å…¥åŠ›ã—ãŸãƒ†ã‚¹ãƒˆæ™‚é–“ã‚’åæ˜ ï¼ˆåˆ† â†’ ç§’ï¼‰
        timeRemaining = testTimeMinutes * 60;
       
        // ğŸŸ¢ ã‚¹ã‚¿ãƒ¼ãƒˆç›´å¾Œã«æ­£ã—ã„æ®‹ã‚Šæ™‚é–“ã‚’è¡¨ç¤º
        let minutes = Math.floor(timeRemaining / 60);
        let seconds = timeRemaining % 60;
        if (seconds < 10) seconds = '0' + seconds;
        document.getElementById('timer').textContent = `${minutes}:${seconds}`;

        timerInterval = setInterval(updateTimer, 1000);
        updateTimer();
    }
});

</script>
